///////////////////////////////////////////////////////////////////////////////////////
// The System Timer

#include <avr/io.h>
#include <avr/interrupt.h>

#include "sys_timer.h"

///////////////////////////////////////////////////////////////////////////////////////
volatile uint16_t counter = 0x00000000;

///////////////////////////////////////////////////////////////////////////////////////
ISR(TIMER0_OVF0_vect)
{
	counter--;
	TCCR0 = SYS_TIMER_CONFIG;
	TCNT0 = SYS_CNT_CONFIG;
}

///////////////////////////////////////////////////////////////////////////////////////
void SYSTIM_Init(void)
{
	TCCR0 = SYS_TIMER_CONFIG;
	TCNT0 = SYS_CNT_CONFIG;
	TIMSK |= (1<<TOIE0);
}

///////////////////////////////////////////////////////////////////////////////////////
int16_t SYSTIM_Get(uint16_t time)
{
	return (counter - time);
}

///////////////////////////////////////////////////////////////////////////////////////
void SYSTIM_Set(uint16_t *time, uint16_t tmout)
{
	*time = (counter - tmout);
}

///////////////////////////////////////////////////////////////////////////////////////
void SYSTIM_Delay(uint16_t time)
{
	uint16_t delay = 0;

	SYSTIM_Set(&delay, time);

	while(SYSTIM_Get(delay) > 0)
	{
		asm("nop");
	}
}

